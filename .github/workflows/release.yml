name: Release

on:
  push:
    tags:
      - "v*"

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Create Release
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Build release binary
        run: cargo build --release

      - name: Package archive
        id: package
        run: |
          set -euo pipefail
          version="${GITHUB_REF_NAME}"
          archive="gclip-${version}-macos.tar.gz"
          tar -czf "${archive}" -C target/release gclip
          sha256="$(shasum -a 256 "${archive}" | awk '{print $1}')"
          echo "archive=${archive}" >> "${GITHUB_OUTPUT}"
          echo "sha256=${sha256}" >> "${GITHUB_OUTPUT}"

      - name: Get commit summary
        id: get_commit_summary
        run: |
          set -euo pipefail
          previous_tag="$(git tag --sort=-creatordate | sed -n 2p)"
          if [[ -z "${previous_tag}" ]]; then
            echo "summary=Initial release" >> "${GITHUB_OUTPUT}"
            exit 0
          fi
          summary="$(git log --oneline --pretty=tformat:"%h %s" "${previous_tag}..${GITHUB_REF}")"
          summary="${summary//$'\n'/'%0A'}"
          echo "summary=${summary}" >> "${GITHUB_OUTPUT}"

      - name: Create release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body: |
            ${{ steps.get_commit_summary.outputs.summary }}
          draft: false
          prerelease: false

      - name: Upload release asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.package.outputs.archive }}
          asset_name: ${{ steps.package.outputs.archive }}
          asset_content_type: application/gzip

      - name: Dispatch to Homebrew tap
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          repository: godslew/homebrew-tap
          event-type: released
          client-payload: |
            {
              "ref": "${{ github.ref }}",
              "sha256": "${{ steps.package.outputs.sha256 }}",
              "binary": "gclip",
              "formula": "gclip-cli",
              "class": "GclipCli",
              "asset": "${{ steps.package.outputs.archive }}",
              "repo": "godslew/gclip-cli"
            }
